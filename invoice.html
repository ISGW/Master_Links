<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice</title>
  <!-- Add html2canvas library (jsPDF is no longer needed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary-color: #2672d6;
      --secondary-color: #f8f9fa;
      --border-color: #e0e0e0;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --text-color: #333333;
      --light-text: #707070;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      background-color: #f8f9fa;
      margin: 0;
      font-size: 16px;
      display: flex;
      flex-direction: column;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 30px auto;
      background: #fff;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      flex: 1;
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      font-size: 28px;
      margin-bottom: 30px;
      font-weight: 600;
    }

    h3 {
      color: var(--primary-color);
      font-size: 18px;
      margin-top: 30px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--secondary-color);
    }

    label {
      font-size: 16px;
      font-weight: 500;
      color: var(--light-text);
      display: inline-block;
      width: 80px;
    }

    input[type="text"], input[type="date"], input[type="number"] {
      font-size: 16px;
      border: 1px solid var(--border-color);
      font-family: inherit;
      padding: 8px 12px;
      width: 280px;
      border-radius: 4px;
      transition: all 0.3s ease;
      background-color: #6088ff2a;
    }

    input[type="number"]:hover, input[type="text"]:hover, input[type="date"]:hover {
      background-color: #f8f9fa;
      border-color: var(--primary-color);
    }
    
    input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus {
      border-color: var(--primary-color);
      background-color: #fff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(62, 130, 255, 0.577);
    }

    .datalist-input {
      width: 100%;
    }

    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s ease;
      font-weight: 500;
    }

    .add-btn {
      background-color: #6c757d;
      margin-top: 15px;
    }

    .add-btn:hover {
      background-color: #5a6268;
    }

    .print-btn {
      background-color: var(--primary-color);
      margin-top: 10px;
      display: inline-block;
      width: 50px;
      align-self: center;
      min-width: 300px;
      text-align: center;
      font-weight: bold;
      margin-right: 10px;
      margin-bottom: 20px;
    }

    .print-btn:hover {
      background-color: #16427c;
    }

    .image-btn {
      background-color: #28a745;
      margin-top: 10px;
      display: inline-block;
      width: 50px;
      align-self: center;
      min-width: 300px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .image-btn:hover {
      background-color: #218838;
    }

    .buttons-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 4px;
      overflow: hidden;
    }

    th, td {
      padding: 9px 15px;
      text-align: left;
      border: 1px solid var(--border-color);
    }

    th {
      background-color: var(--secondary-color);
      font-size: 14px;
      font-weight: 600;
      color: var(--light-text);
    }

    td {
      background-color: #fff;
      font-size: 15px;
    }

    .total-section {
      margin-top: 30px;
      background-color: var(--secondary-color);
      padding: 20px;
      border-radius: 6px;
    }

    .total-section div {
      font-size: 16px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total-section input {
      width: 150px;
      text-align: right;
    }

    .status-section {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
    }

    .status-badge {
      font-size: 18px;
      font-weight: bolder;
      padding: 8px 16px;
      border-radius: 4px;
      letter-spacing: 1px;
    }

    .paid {
      background-color: rgba(46, 204, 113, 0.1);
      color: var(--success-color);
    }

    .due {
      background-color: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }

    .partial {
      background-color: rgba(243, 156, 18, 0.1);
      color: var(--warning-color);
    }

    .footer {
      margin-top: 0px;
      font-size: 10px;
      line-height: 1;
      color: #9090905e;
      text-align: left;
      padding: 10px;
      width: 98%; 
    }

    .company-info {
      display: flex;
      font-size: 14px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .company-details {
      max-width: 60%;
      line-height: 1.4;
    }

    .company-details h2 {
      color: var(--primary-color);
      margin-bottom: 8px;
      margin-top: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .company-details p {
      margin: 4px 0;
      color: var(--light-text);
    }

    .company-logo img {
      max-width: 100px;
      height: auto;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .invoice-number {
      background-color: var(--secondary-color);
      padding: 10px 15px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.5px;
    }

    .regenerate-btn {
      background-color: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .regenerate-btn:hover {
      background-color: var(--primary-color);
      color: white;
    }

    /* Print-specific styles */
    @media print {
      body {
        background-color: #fff;
      }
      
      .container {
        margin: 0;
        padding: 20px;
        box-shadow: none;
        max-width: 100%;
      }
      
      .print-btn, .add-btn, .regenerate-btn, .image-btn, .buttons-container {
        display: none;
      }
      
      input[type="text"], input[type="date"], input[type="number"] {
        border: none;
        box-shadow: none;
        padding: 4px 0;
        background: transparent;
      }
      
      .total-section {
        background-color: transparent;
        padding: 10px 0;
      }
      
      th {
        background-color: #f8f9fa !important;
        color: #000 !important;
      }
      
      .status-badge {
        border: 1px solid currentColor;
        background-color: transparent !important;
      }
    }
  </style>
</head>
<body>

<div class="container">
  
  <div class="company-info">
    <div class="company-details">
      <h2>ISG Tulsa</h2>
      <p>7633 E 63RD PL STE 300</p>
      <p>TULSA, OK 74133</p>
      <p>(918) 308-1138</p>
      <p>contact@isgtulsa.com</p>
    </div>

    <div class="company-logo">
      <svg width="90" height="90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 798.67 363.86">
        <defs>
<style>
      .cls-1 {
        fill: var(--primary-color);
      }
    </style>
  </defs>
  <g id="Layer_1-2" data-name="Layer 1">
    <g>
      <path class="cls-1" d="M181.93,0h0C81.45,0,0,81.45,0,181.93H0c0,100.48,81.45,181.93,181.93,181.93h0c100.48,0,181.93-81.45,181.93-181.93h0C363.86,81.45,282.41,0,181.93,0Zm64.65,124.91c.51-.46,1.32-.1,1.31,.59l-.24,33.7c0,.22-.09,.43-.26,.58l-3.2,2.91-24.76,22.53c-.51,.46-1.32,.1-1.31-.59l.24-33.7c0-.22,.09-.43,.26-.58l25.83-23.51,2.12-1.93Zm-130.1-10.85c9.38-3.22,18.46-7.07,27.21-11.49,26.47-13.37,49.84-32,68.71-54.53,.28-.34,.79-.38,1.12-.09,1.5,1.3,2.92,2.71,4.24,4.2,.02,.02,.04,.05,.06,.07,2.87,3.85,5.15,7.51,6.92,10.98,.69,1.33,1.3,2.64,1.84,3.92,0,.02,.02,.04,.03,.07,1.64,4.67,2.52,9.69,2.52,14.93,0,8.26-2.22,16.01-6.09,22.67-.02,.04-.05,.07-.07,.11-2.66,3.8-5.5,7.18-8.5,10.28-.03,.05-.07,.08-.1,.1-.89,.85-1.79,1.69-2.7,2.51-2.81,2.58-5.69,5.07-8.64,7.49-7.21,5.56-15.24,10.62-24.15,16.5-.17,.13-.35,.24-.52,.36l-11.08,7.06c-12.13,7.47-20.44,20.52-21.4,35.56-.04,.66-.82,.99-1.31,.55l-20.57-18.71-4.26-3.88-3.2-2.91c-.16-.15-.26-.36-.26-.58l-.32-44.42c0-.34,.21-.63,.53-.74Zm131.43,200.28c0,.97-.78,1.75-1.75,1.75H117.7c-.97,0-1.75-.79-1.75-1.75v-29.84c0-.97,.79-1.75,1.75-1.75H246.15c.97,0,1.75,.78,1.75,1.75v29.84Zm47.18-60.57c-.05,.39-.38,.69-.78,.69H69.56c-.4,0-.73-.3-.78-.69l-5.01-40.37c-.06-.52,.39-.96,.91-.87l61.24,9.95c.12,.02,.24,.01,.36-.03l55.24-17.2c.15-.05,.31-.05,.47,0l55.59,17.2c.12,.04,.24,.04,.36,.02l61.25-9.95c.52-.08,.97,.35,.91,.87l-5.01,40.37Z"/>
      <g>
        <rect class="cls-1" x="426.7" y="94.64" width="42.31" height="174.58"/>
        <path class="cls-1" d="M603.66,178.97h0c-5.88-4.7-12.39-8.91-19.37-12.52-6.56-3.39-12.69-6.75-18.22-10-5.22-3.06-9.65-6.35-13.15-9.79-2.78-2.72-4.13-5.81-4.13-9.45s1.3-6.17,4.1-8.44c3.06-2.49,7.37-3.75,12.83-3.75,4.65,0,9.61,.4,14.73,1.18,5.15,.79,11.06,2.14,17.57,4.02l4.66,1.34,12.37-30.42-5.59-1.74c-4.88-1.52-9.33-2.8-13.23-3.8-3.97-1.01-7.86-1.8-11.58-2.36-3.66-.54-7.21-.94-10.56-1.17-3.35-.23-6.85-.35-10.4-.35-7.22,0-14.17,.94-20.64,2.8-6.63,1.91-12.54,4.83-17.56,8.68-5.16,3.96-9.29,9.08-12.27,15.21-2.98,6.12-4.49,13.36-4.49,21.51,0,9.14,2.19,17.14,6.5,23.77,4.08,6.29,9.29,11.83,15.48,16.47,5.94,4.45,12.39,8.45,19.17,11.88,6.39,3.23,12.46,6.55,18.05,9.85,5.26,3.11,9.65,6.49,13.06,10.03,2.78,2.9,4.13,6.25,4.13,10.24,0,2.13-.46,4.04-1.4,5.82-1.01,1.91-2.42,3.56-4.32,5.05-1.98,1.56-4.39,2.82-7.16,3.74-2.82,.94-5.99,1.41-9.45,1.41-5.34,0-11.47-.68-18.22-2.04-6.66-1.33-13.92-3.88-21.59-7.57l-5.16-2.48-12.67,31.01,4.66,2.16c10.7,4.97,20.62,8.4,29.47,10.19,8.81,1.79,16.72,2.7,23.5,2.7,9.02,0,17.41-1.09,24.92-3.25,7.67-2.2,14.37-5.46,19.91-9.68,5.68-4.32,10.14-9.73,13.28-16.1,3.14-6.36,4.73-13.64,4.73-21.65,0-9.69-2.21-18.15-6.56-25.15-4.13-6.64-9.31-12.48-15.4-17.36Z"/>
        <path class="cls-1" d="M759.29,182.52v54.05c-2.69,.56-5.02,.91-6.94,1.05-3.02,.22-6.15,.32-9.31,.32-8.12,0-15.31-1.55-21.35-4.6-6.11-3.09-11.28-7.23-15.35-12.31-4.15-5.17-7.37-11.19-9.56-17.91-2.22-6.78-3.34-13.87-3.34-21.09s1.13-14.85,3.35-21.79c2.17-6.8,5.44-12.82,9.7-17.89,4.23-5.03,9.51-9.12,15.71-12.15,6.13-3,13.37-4.52,21.52-4.52,4.91,0,10.34,.54,16.16,1.6,5.79,1.06,12.9,3.21,21.12,6.38l5.02,1.94,12.15-31.53-4.81-2.03c-8.88-3.74-17.83-6.43-26.61-8-8.7-1.55-16.45-2.34-23.03-2.34-14.44,0-27.66,2.37-39.3,7.04-11.66,4.68-21.77,11.17-30.04,19.29-8.3,8.14-14.77,17.81-19.24,28.73-4.45,10.89-6.71,22.75-6.71,35.27s2.17,24.11,6.45,34.98c4.3,10.94,10.61,20.61,18.75,28.76,8.14,8.15,18.18,14.62,29.84,19.23,11.61,4.59,24.88,6.91,39.44,6.91,3.33,0,7.2-.24,11.5-.71,4.26-.47,8.77-1.17,13.41-2.1,4.68-.94,9.44-2.16,14.16-3.63,4.75-1.48,9.3-3.18,13.52-5.07l3.19-1.42v-76.48h-39.38Z"/>
      </g>
    </g>
  </g>
</svg>
    </div>
  </div>

  <div class="invoice-header">
    <h1>INVOICE</h1>
    <div>
      <span class="invoice-number" id="invoice-number"></span>
      <!-- <button class="regenerate-btn" onclick="generateInvoiceNumber()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg></button>-->
    </div>
  </div>

  <h3>BILL TO</h3>
  <div class="form-group">
    <label for="customer-name">Name:</label>
    <input type="text" id="customer-name" placeholder="Customer name">
  </div>
  <div class="form-group" style="margin-top: 10px;">
    <label for="invoice-date">Date:</label>
    <input type="date" id="invoice-date">
  </div>

  <h3>Services</h3>
  <table id="invoice-table">
    <thead>
      <tr>
        <th>Service Description</th>
        <th style="width: 150px;">Price ($)</th>
        <th style="width: 150px;">Total ($)</th>
      </tr>
    </thead>
    <tbody id="invoice-body">
      <tr>
        <td>
          <input type="text" list="service-options" placeholder="Service description" class="datalist-input">
          <datalist id="service-options">
            <option value="I-130 Petition Enter Data">
              <option value="I-485 Adjustment of Status Enter Data">
              <option value="NVC Process Enter Data">
              <option value="DACA Renewal Enter Data">
              <option value="I-90 Green Card Renewal Enter Data">
              <option value="N-400 Enter Data">
              <option value="N-600 Application for Certificate Enter Data">
              <option value="I-131 Parole Enter Data">
              <option value="I-601 Waiver Enter Data">
              <option value="I-751 Green Card Remove Conditions Enter Data">
              <option value="I-765 EAD Enter Data">
              <option value="I-129F Petition for Fiance Enter Data">

          </datalist>
        </td>
        <td><input type="number" step="0.01" min="0" placeholder="0.00"></td>
        <td class="total-cell">$0.00</td>
      </tr>
    </tbody>
  </table>

  <!-- <button class="btn add-btn" onclick="addRow()">+ Add Service</button> --> 

  <div class="total-section">
    <div>
      <strong>Total Amount:</strong>
      <span>$<span id="total-amount">0.00</span></span>
    </div>
    <div>
      <strong>Paid Amount:</strong>
      <span>$<input type="number" id="paid-amount" step="0.01" min="0" placeholder="0.00" oninput="updateDueAmount()"></span>
    </div>
    <div>
      <strong>Due Amount:</strong>
      <span>$<span id="due-amount">0.00</span></span>
    </div>
  </div>

  <div class="status-section">
    <div id="status-badge" class="status-badge due">DUE</div>
  </div>
</div>

<div class="footer">
  <p>Integrated Services and Guidance LLC d/b/a ISG Tulsa provides assistance with immigration-related processes, entering data, doing document translations and interpretation. A non-refundable fee was charged for such services. We are not an attorney firm; we do not give legal advice or represent clients in a court of law, nor do we accept fees for legal advice. We are not associated with any government agency. | Integrated Services and Guidance LLC d/b/a ISG Tulsa brinda asistencia con procesos relacionados con inmigración, ingresando datos, realizando traducciones de documentos e interpretación. Se cobró una tarifa no reembolsable por dichos servicios. No somos una firma de abogados; no brindamos asesoramiento legal ni representamos a clientes ante la corte, tampoco aceptamos honorarios por asesoramiento legal. No estamos asociados con ninguna agencia gubernamental.</p>
</div>

<div class="buttons-container">
  <button class="btn print-btn" onclick="saveImageAndPrint()">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer">
      <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
      <path d="M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6"/>
      <rect x="6" y="14" width="12" height="8" rx="1"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-to-line">
      <path d="M12 17V3"/>
      <path d="m6 11 6 6 6-6"/>
      <path d="M19 21H5"/>
    </svg> Print & Download Image
  </button>
  <button class="btn image-btn" onclick="saveAsImage()">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-to-line">
      <path d="M12 17V3"/>
      <path d="m6 11 6 6 6-6"/>
      <path d="M19 21H5"/>
    </svg> Download Image
  </button>
</div>

<script>
  // Set default date to today and generate invoice number on load
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoice-date').value = today;
    generateInvoiceNumber();
  });

  function generateInvoiceNumber() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const dateString = `${year}${month}${day}`;
    
    // Generate random 4-digit number
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    
    const invoiceNumber = `${dateString}-${randomNum}`;
    document.getElementById('invoice-number').textContent = invoiceNumber;
  }

  function addRow() {
    const tableBody = document.getElementById("invoice-body");
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td>
        <input type="text" list="service-options" placeholder="Service description" class="datalist-input">
      </td>
      <td><input type="number" step="0.01" min="0" placeholder="0.00"></td>
      <td class="total-cell">$0.00</td>
    `;
    tableBody.appendChild(newRow);
    
    // Add event listeners to the new row
    const inputs = newRow.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('input', updateTotal);
    });
    
    updateTotal();
  }

  function updateTotal() {
    const rows = document.querySelectorAll("#invoice-body tr");
    let totalAmount = 0;

    rows.forEach(row => {
      const unitPrice = parseFloat(row.querySelector("td:nth-child(2) input").value) || 0;
      const totalCell = row.querySelector(".total-cell");
      totalCell.textContent = `$${unitPrice.toFixed(2)}`;
      totalAmount += unitPrice;
    });

    document.getElementById("total-amount").textContent = totalAmount.toFixed(2);
    updateDueAmount();
  }

  function updateDueAmount() {
    const totalAmount = parseFloat(document.getElementById("total-amount").textContent) || 0;
    const paidAmount = parseFloat(document.getElementById("paid-amount").value) || 0;
    const dueAmount = Math.max(0, (totalAmount - paidAmount).toFixed(2));

    document.getElementById("due-amount").textContent = dueAmount;
    updateStatus();
  }

  function updateStatus() {
    const totalAmount = parseFloat(document.getElementById("total-amount").textContent) || 0;
    const paidAmount = parseFloat(document.getElementById("paid-amount").value) || 0;
    const dueAmount = totalAmount - paidAmount;
    const badge = document.getElementById("status-badge");

    if (totalAmount === 0) {
      badge.textContent = "DRAFT";
      badge.classList.remove("paid", "partial", "due");
      badge.classList.add("due");
    } else if (dueAmount <= 0) {
      badge.textContent = "PAID";
      badge.classList.remove("due", "partial");
      badge.classList.add("paid");
    } else if (paidAmount > 0 && paidAmount < totalAmount) {
      badge.textContent = "PARTIAL";
      badge.classList.remove("paid", "due");
      badge.classList.add("partial");
    } else {
      badge.textContent = "DUE";
      badge.classList.remove("paid", "partial");
      badge.classList.add("due");
    }
  }

  // Shared function to generate invoice image
  function generateInvoiceImage() {
    return new Promise((resolve, reject) => {
      // Add print-specific styles temporarily to make it look like the print version
      document.body.classList.add('preparing-image');
      
      // Create a style element for temporary print-like styling
      const tempStyle = document.createElement('style');
      tempStyle.textContent = `
        .preparing-image input[type="text"], 
        .preparing-image input[type="date"], 
        .preparing-image input[type="number"] {
          border: none !important;
          box-shadow: none !important;
          padding: 4px 0 !important;
          background: transparent !important;
        }
        
        .preparing-image .total-section {
          background-color: transparent !important;
          padding: 10px 0 !important;
        }
        
        .preparing-image th {
          background-color: #f8f9fa !important;
          color: #000 !important;
        }
        
        .preparing-image .status-badge {
          border: 1px solid currentColor !important;
          background-color: transparent !important;
        }
        
        .preparing-image .buttons-container {
          display: none !important;
        }
      `;
      document.head.appendChild(tempStyle);

      // Calculate what needs to be captured
      const container = document.querySelector(".container");
      const footer = document.querySelector(".footer");
      
      // Create a temporary wrapper div to hold both container and footer
      const wrapper = document.createElement('div');
      wrapper.style.background = '#fff';
      wrapper.style.maxWidth = '800px';
      wrapper.style.margin = '0 auto';
      wrapper.style.padding = '0';
      
      // Clone the elements to avoid modifying the originals
      const containerClone = container.cloneNode(true);
      const footerClone = footer.cloneNode(true);
      
      // Append clones to wrapper
      wrapper.appendChild(containerClone);
      wrapper.appendChild(footerClone);
      
      // Temporarily add wrapper to document
      document.body.appendChild(wrapper);
      
      // Use html2canvas to capture the wrapper
      html2canvas(wrapper, {
        scale: 1.5,
        useCORS: true,
        logging: false,
        allowTaint: true,
        backgroundColor: '#ffffff'
      }).then(canvas => {
        // Convert canvas to JPEG
        const jpegData = canvas.toDataURL('image/jpeg', 0.9);
        
        // Clean up
        document.body.removeChild(wrapper);
        document.head.removeChild(tempStyle);
        document.body.classList.remove('preparing-image');
        
        resolve({
          jpegData: jpegData,
          customerName: document.getElementById("customer-name").value.trim() || "unnamed",
          invoiceNumber: document.getElementById("invoice-number").textContent
        });
      }).catch(err => {
        // Clean up in case of error
        if (document.body.contains(wrapper)) document.body.removeChild(wrapper);
        if (document.head.contains(tempStyle)) document.head.removeChild(tempStyle);
        document.body.classList.remove('preparing-image');
        reject(err);
      });
    });
  }

  // New function that combines image saving and printing
  function saveImageAndPrint() {
    generateInvoiceImage().then(result => {
      // Create a temporary link and trigger download
      const link = document.createElement('a');
      link.download = `ISG invoice-${result.customerName}-${result.invoiceNumber}.jpg`;
      link.href = result.jpegData;
      link.click();
      
      // Trigger the print dialog after a slight delay
      setTimeout(() => {
        window.print();
      }, 500);
    }).catch(err => {
      console.error("Error generating invoice image:", err);
      alert("There was an error generating the invoice image. Please try again.");
    });
  }

  // Function to just save the image (no printing)
  function saveAsImage() {
    generateInvoiceImage().then(result => {
      // Create a temporary link and trigger download
      const link = document.createElement('a');
      link.download = `ISG invoice-${result.customerName}-${result.invoiceNumber}.jpg`;
      link.href = result.jpegData;
      link.click();
    }).catch(err => {
      console.error("Error saving invoice as image:", err);
      alert("There was an error saving the invoice as an image. Please try again.");
    });
  }

  // Add input event listeners to all initial inputs
  document.getElementById("invoice-body").addEventListener("input", updateTotal);
  
  // Initialize calculations
  updateTotal();
</script>

</body>
</html>
