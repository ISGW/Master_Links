<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Invoice</title>
  <!-- Add html2canvas library (jsPDF is no longer needed) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    :root {
      --primary-color: #2672d6;
      --secondary-color: #f8f9fa;
      --border-color: #e0e0e0;
      --success-color: #2ecc71;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
      --text-color: #333333;
      --light-text: #707070;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      background-color: #f8f9fa;
      margin: 0;
      font-size: 16px;
      display: flex;
      flex-direction: column;
      line-height: 1.6;
    }
    
    .container {
      max-width: 800px;
      margin: 30px auto;
      background: #fff;
      padding: 40px;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
      flex: 1;
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      font-size: 28px;
      margin-bottom: 30px;
      font-weight: 600;
    }

    h3 {
      color: var(--primary-color);
      font-size: 18px;
      margin-top: 30px;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 2px solid var(--secondary-color);
    }

    label {
      font-size: 16px;
      font-weight: 500;
      color: var(--light-text);
      display: inline-block;
      width: 80px;
    }

    input[type="text"], input[type="date"], input[type="number"] {
      font-size: 16px;
      border: 1px solid var(--border-color);
      font-family: inherit;
      padding: 8px 12px;
      width: 280px;
      border-radius: 4px;
      transition: all 0.3s ease;
      background-color: #6088ff2a;
    }

    input[type="number"]:hover, input[type="text"]:hover, input[type="date"]:hover {
      background-color: #f8f9fa;
      border-color: var(--primary-color);
    }
    
    input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus {
      border-color: var(--primary-color);
      background-color: #fff;
      outline: none;
      box-shadow: 0 0 0 3px rgba(62, 130, 255, 0.577);
    }

    .datalist-input {
      width: 100%;
    }

    .btn {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      transition: background-color 0.3s ease;
      font-weight: 500;
    }

    .add-btn {
      background-color: #6c757d;
      margin-top: 15px;
    }

    .add-btn:hover {
      background-color: #5a6268;
    }

    .print-btn {
      background-color: var(--primary-color);
      margin-top: 10px;
      display: inline-block;
      width: 50px;
      align-self: center;
      min-width: 300px;
      text-align: center;
      font-weight: bold;
      margin-right: 10px;
      margin-bottom: 20px;
    }

    .print-btn:hover {
      background-color: #16427c;
    }

    .image-btn {
      background-color: #28a745;
      margin-top: 10px;
      display: inline-block;
      width: 50px;
      align-self: center;
      min-width: 300px;
      text-align: center;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .image-btn:hover {
      background-color: #218838;
    }

    .buttons-container {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      border-radius: 4px;
      overflow: hidden;
    }

    th, td {
      padding: 9px 15px;
      text-align: left;
      border: 1px solid var(--border-color);
    }

    th {
      background-color: var(--secondary-color);
      font-size: 14px;
      font-weight: 600;
      color: var(--light-text);
    }

    td {
      background-color: #fff;
      font-size: 15px;
    }

    .total-section {
      margin-top: 30px;
      background-color: var(--secondary-color);
      padding: 20px;
      border-radius: 6px;
    }

    .total-section div {
      font-size: 16px;
      margin: 10px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .total-section input {
      width: 150px;
      text-align: right;
    }

    .status-section {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
    }

    .status-badge {
      font-size: 18px;
      font-weight: bolder;
      padding: 8px 16px;
      border-radius: 4px;
      letter-spacing: 1px;
    }

    .paid {
      background-color: rgba(46, 204, 113, 0.1);
      color: var(--success-color);
    }

    .due {
      background-color: rgba(231, 76, 60, 0.1);
      color: var(--danger-color);
    }

    .partial {
      background-color: rgba(243, 156, 18, 0.1);
      color: var(--warning-color);
    }

    .footer {
      margin-top: 0px;
      font-size: 10px;
      line-height: 1;
      color: #9090905e;
      text-align: left;
      padding: 10px;
      width: 98%; 
    }

    .company-info {
      display: flex;
      font-size: 14px;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
    }

    .company-details {
      max-width: 60%;
      line-height: 1.4;
    }

    .company-details h2 {
      color: var(--primary-color);
      margin-bottom: 8px;
      margin-top: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .company-details p {
      margin: 4px 0;
      color: var(--light-text);
    }

    .company-logo img {
      max-width: 100px;
      height: auto;
    }

    .invoice-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .invoice-number {
      background-color: var(--secondary-color);
      padding: 10px 15px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 16px;
      letter-spacing: 0.5px;
    }

    .regenerate-btn {
      background-color: transparent;
      color: var(--primary-color);
      border: 1px solid var(--primary-color);
      padding: 5px 10px;
      font-size: 12px;
      cursor: pointer;
      border-radius: 4px;
      margin-left: 10px;
      transition: all 0.3s ease;
    }

    .regenerate-btn:hover {
      background-color: var(--primary-color);
      color: white;
    }

    /* Print-specific styles */
    @media print {
      body {
        background-color: #fff;
      }
      
      .container {
        margin: 0;
        padding: 20px;
        box-shadow: none;
        max-width: 100%;
      }
      
      .print-btn, .add-btn, .regenerate-btn, .image-btn, .buttons-container {
        display: none;
      }
      
      input[type="text"], input[type="date"], input[type="number"] {
        border: none;
        box-shadow: none;
        padding: 4px 0;
        background: transparent;
      }
      
      .total-section {
        background-color: transparent;
        padding: 10px 0;
      }
      
      th {
        background-color: #f8f9fa !important;
        color: #000 !important;
      }
      
      .status-badge {
        border: 1px solid currentColor;
        background-color: transparent !important;
      }
    }
  </style>
</head>
<body>

<div class="container">
  
  <div class="company-info">
    <div class="company-details">
      <h2>ISG Tulsa</h2>
      <p>7633 E 63RD PL STE 300</p>
      <p>TULSA, OK 74133</p>
      <p>(918) 308-1138</p>
      <p>contact@isgtulsa.com</p>
    </div>

    <div class="company-logo">
      <svg width="90" height="90" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 884.77 408.65">
        <defs>

    <style>
      .cls-1 {
        fill: var(--primary-color);
      }
    </style>
  </defs>
  <g id="Layer_1-2" data-name="Layer 1">
    <g>
      <g>
        <path class="cls-1" d="M174.51,143.72c.26-.18,.53-.35,.79-.55,13.58-8.96,25.8-16.66,36.79-25.13,4.5-3.69,8.87-7.48,13.16-11.41,1.38-1.25,2.75-2.54,4.11-3.83,.05-.04,.11-.09,.16-.16,4.57-4.72,8.89-9.87,12.94-15.66l.1-.16c5.91-10.15,9.28-21.94,9.28-34.53,0-7.97-1.35-15.62-3.84-22.73-.01-.04-.03-.07-.04-.1-.82-1.94-1.75-3.93-2.8-5.96-2.69-5.27-6.17-10.85-10.54-16.72-.03-.04-.06-.07-.09-.11-2.01-2.27-4.17-4.4-6.46-6.39-.5-.44-1.27-.37-1.7,.14-28.73,34.3-64.32,62.68-104.64,83.04-13.33,6.73-27.16,12.6-41.44,17.5-.48,.17-.81,.62-.8,1.13l.48,67.64c0,.33,.14,.65,.39,.88l4.87,4.43,6.49,5.91,31.32,28.49c.75,.68,1.94,.18,2-.83,1.46-22.9,14.13-42.77,32.6-54.15l16.88-10.76Z"/>
        <path class="cls-1" d="M359.91,252.25l-7.63,61.49c-.07,.6-.58,1.05-1.19,1.05H8.82c-.6,0-1.11-.45-1.19-1.05L0,252.25c-.1-.79,.59-1.46,1.38-1.33l93.27,15.15c.18,.03,.37,.02,.55-.04l84.13-26.19c.23-.07,.48-.07,.71,0l84.66,26.19c.18,.05,.36,.07,.55,.04l93.29-15.15c.79-.13,1.48,.54,1.38,1.33Z"/>
        <path class="cls-1" d="M280.42,118.39l-.36,51.32c0,.33-.14,.65-.39,.88l-4.87,4.43-37.71,34.31c-.77,.7-2.01,.15-2-.89l.36-51.32c0-.33,.14-.65,.39-.88l39.34-35.8,3.23-2.94c.77-.7,2.01-.15,2,.89Z"/>
        <rect class="cls-1" x="79.48" y="357.86" width="200.96" height="50.79" rx=".81" ry=".81"/>
      </g>
      <g>
        <rect class="cls-1" x="459.12" y="205.53" width="48.42" height="199.77"/>
        <path class="cls-1" d="M661.62,302.02h0c-6.73-5.38-14.18-10.2-22.17-14.33-7.5-3.88-14.52-7.73-20.85-11.44-5.97-3.5-11.04-7.27-15.05-11.2-3.18-3.11-4.73-6.65-4.73-10.81s1.49-7.06,4.69-9.66c3.5-2.85,8.44-4.29,14.68-4.29,5.32,0,10.99,.45,16.86,1.35,5.89,.9,12.65,2.45,20.11,4.6l5.33,1.54,14.15-34.8-6.4-1.99c-5.59-1.74-10.68-3.2-15.14-4.34-4.54-1.16-9-2.06-13.25-2.7-4.19-.62-8.26-1.07-12.08-1.34-3.83-.27-7.84-.4-11.9-.4-8.27,0-16.21,1.08-23.62,3.2-7.59,2.18-14.35,5.52-20.1,9.93-5.91,4.53-10.63,10.39-14.04,17.41-3.41,7.01-5.13,15.29-5.13,24.61,0,10.46,2.5,19.61,7.44,27.2,4.67,7.19,10.63,13.54,17.71,18.85,6.79,5.1,14.17,9.67,21.93,13.59,7.31,3.7,14.26,7.49,20.65,11.28,6.02,3.56,11.05,7.43,14.94,11.47,3.18,3.31,4.73,7.15,4.73,11.72,0,2.44-.52,4.62-1.6,6.66-1.15,2.18-2.77,4.07-4.94,5.78-2.27,1.79-5.02,3.23-8.2,4.28-3.22,1.07-6.86,1.62-10.81,1.62-6.11,0-13.12-.78-20.84-2.33-7.62-1.52-15.93-4.44-24.7-8.66l-5.9-2.84-14.5,35.48,5.33,2.47c12.24,5.68,23.59,9.61,33.72,11.66,10.08,2.05,19.13,3.09,26.89,3.09,10.33,0,19.92-1.25,28.52-3.72,8.78-2.52,16.44-6.25,22.78-11.07,6.49-4.94,11.61-11.14,15.2-18.42,3.59-7.27,5.41-15.61,5.41-24.77,0-11.09-2.53-20.77-7.51-28.78-4.72-7.6-10.65-14.29-17.62-19.86Z"/>
        <path class="cls-1" d="M839.7,306.09v61.85c-3.08,.64-5.74,1.05-7.94,1.2-3.46,.25-7.04,.37-10.65,.37-9.3,0-17.51-1.77-24.43-5.27-7-3.54-12.91-8.27-17.57-14.09-4.75-5.92-8.43-12.81-10.94-20.49-2.54-7.76-3.82-15.88-3.82-24.13s1.29-16.99,3.83-24.94c2.49-7.78,6.22-14.67,11.1-20.47,4.84-5.76,10.88-10.43,17.97-13.9,7.02-3.43,15.3-5.17,24.62-5.17,5.61,0,11.84,.62,18.49,1.83,6.63,1.21,14.76,3.67,24.16,7.3l5.75,2.22,13.91-36.08-5.51-2.32c-10.16-4.28-20.4-7.36-30.45-9.15-9.95-1.77-18.82-2.67-26.35-2.67-16.52,0-31.65,2.71-44.97,8.05-13.34,5.35-24.91,12.78-34.38,22.08-9.5,9.32-16.91,20.38-22.02,32.88-5.09,12.46-7.68,26.04-7.68,40.36s2.48,27.59,7.38,40.03c4.92,12.51,12.14,23.58,21.45,32.91,9.31,9.33,20.8,16.73,34.15,22,13.28,5.25,28.47,7.91,45.13,7.91,3.81,0,8.24-.27,13.15-.81,4.88-.53,10.04-1.34,15.34-2.4,5.36-1.07,10.81-2.47,16.2-4.16,5.43-1.69,10.64-3.64,15.47-5.8l3.65-1.63v-87.51h-45.07Z"/>
      </g>
    </g>
  </g>
</svg>    </div>
  </div>

  <div class="invoice-header">
    <h1>INVOICE</h1>
    <div>
      <span class="invoice-number" id="invoice-number"></span>
      <!-- <button class="regenerate-btn" onclick="generateInvoiceNumber()"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg></button>-->
    </div>
  </div>

  <h3>BILL TO</h3>
  <div class="form-group">
    <label for="customer-name">Name:</label>
    <input type="text" id="customer-name" placeholder="Customer name">
  </div>
  <div class="form-group" style="margin-top: 10px;">
    <label for="invoice-date">Date:</label>
    <input type="date" id="invoice-date">
  </div>

  <h3>Services</h3>
  <table id="invoice-table">
    <thead>
      <tr>
        <th>Service Description</th>
        <th style="width: 150px;">Price ($)</th>
        <th style="width: 150px;">Total ($)</th>
      </tr>
    </thead>
    <tbody id="invoice-body">
      <tr>
        <td>
          <input type="text" list="service-options" placeholder="Service description" class="datalist-input">
          <datalist id="service-options">
            <option value="I-130 Petition Enter Data">
              <option value="I-485 Adjustment of Status Enter Data">
              <option value="NVC Process Enter Data">
              <option value="DACA Renewal Enter Data">
              <option value="I-90 Green Card Renewal Enter Data">
              <option value="N-400 Enter Data">
              <option value="N-600 Application for Certificate Enter Data">
              <option value="I-131 Parole Enter Data">
              <option value="I-601 Waiver Enter Data">
              <option value="I-751 Green Card Remove Conditions Enter Data">
              <option value="I-765 EAD Enter Data">
              <option value="I-129F Petition for Fiance Enter Data">

          </datalist>
        </td>
        <td><input type="number" step="0.01" min="0" placeholder="0.00"></td>
        <td class="total-cell">$0.00</td>
      </tr>
    </tbody>
  </table>

  <!-- <button class="btn add-btn" onclick="addRow()">+ Add Service</button> --> 

  <div class="total-section">
    <div>
      <strong>Total Amount:</strong>
      <span>$<span id="total-amount">0.00</span></span>
    </div>
    <div>
      <strong>Paid Amount:</strong>
      <span>$<input type="number" id="paid-amount" step="0.01" min="0" placeholder="0.00" oninput="updateDueAmount()"></span>
    </div>
    <div>
      <strong>Due Amount:</strong>
      <span>$<span id="due-amount">0.00</span></span>
    </div>
  </div>

  <div class="status-section">
    <div id="status-badge" class="status-badge due">DUE</div>
  </div>
</div>

<div class="footer">
  <p>Integrated Services and Guidance LLC d/b/a ISG Tulsa provides assistance with immigration-related processes, entering data, doing document translations and interpretation. A non-refundable fee was charged for such services. We are not an attorney firm; we do not give legal advice or represent clients in a court of law, nor do we accept fees for legal advice. We are not associated with any government agency. | Integrated Services and Guidance LLC d/b/a ISG Tulsa brinda asistencia con procesos relacionados con inmigración, ingresando datos, realizando traducciones de documentos e interpretación. Se cobró una tarifa no reembolsable por dichos servicios. No somos una firma de abogados; no brindamos asesoramiento legal ni representamos a clientes ante la corte, tampoco aceptamos honorarios por asesoramiento legal. No estamos asociados con ninguna agencia gubernamental.</p>
</div>

<div class="buttons-container">
  <button class="btn print-btn" onclick="saveImageAndPrint()">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer">
      <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
      <path d="M6 9V3a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v6"/>
      <rect x="6" y="14" width="12" height="8" rx="1"/>
    </svg>
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-to-line">
      <path d="M12 17V3"/>
      <path d="m6 11 6 6 6-6"/>
      <path d="M19 21H5"/>
    </svg> Print & Download Image
  </button>
  <button class="btn image-btn" onclick="saveAsImage()">
    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" style="vertical-align: middle;" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-down-to-line">
      <path d="M12 17V3"/>
      <path d="m6 11 6 6 6-6"/>
      <path d="M19 21H5"/>
    </svg> Download Image
  </button>
</div>

<script>
  // Set default date to today and generate invoice number on load
  document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('invoice-date').value = today;
    generateInvoiceNumber();
  });

  function generateInvoiceNumber() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const dateString = `${year}${month}${day}`;
    
    // Generate random 4-digit number
    const randomNum = Math.floor(1000 + Math.random() * 9000);
    
    const invoiceNumber = `${dateString}-${randomNum}`;
    document.getElementById('invoice-number').textContent = invoiceNumber;
  }

  function addRow() {
    const tableBody = document.getElementById("invoice-body");
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td>
        <input type="text" list="service-options" placeholder="Service description" class="datalist-input">
      </td>
      <td><input type="number" step="0.01" min="0" placeholder="0.00"></td>
      <td class="total-cell">$0.00</td>
    `;
    tableBody.appendChild(newRow);
    
    // Add event listeners to the new row
    const inputs = newRow.querySelectorAll('input');
    inputs.forEach(input => {
      input.addEventListener('input', updateTotal);
    });
    
    updateTotal();
  }

  function updateTotal() {
    const rows = document.querySelectorAll("#invoice-body tr");
    let totalAmount = 0;

    rows.forEach(row => {
      const unitPrice = parseFloat(row.querySelector("td:nth-child(2) input").value) || 0;
      const totalCell = row.querySelector(".total-cell");
      totalCell.textContent = `$${unitPrice.toFixed(2)}`;
      totalAmount += unitPrice;
    });

    document.getElementById("total-amount").textContent = totalAmount.toFixed(2);
    updateDueAmount();
  }

  function updateDueAmount() {
    const totalAmount = parseFloat(document.getElementById("total-amount").textContent) || 0;
    const paidAmount = parseFloat(document.getElementById("paid-amount").value) || 0;
    const dueAmount = Math.max(0, (totalAmount - paidAmount).toFixed(2));

    document.getElementById("due-amount").textContent = dueAmount;
    updateStatus();
  }

  function updateStatus() {
    const totalAmount = parseFloat(document.getElementById("total-amount").textContent) || 0;
    const paidAmount = parseFloat(document.getElementById("paid-amount").value) || 0;
    const dueAmount = totalAmount - paidAmount;
    const badge = document.getElementById("status-badge");

    if (totalAmount === 0) {
      badge.textContent = "DRAFT";
      badge.classList.remove("paid", "partial", "due");
      badge.classList.add("due");
    } else if (dueAmount <= 0) {
      badge.textContent = "PAID";
      badge.classList.remove("due", "partial");
      badge.classList.add("paid");
    } else if (paidAmount > 0 && paidAmount < totalAmount) {
      badge.textContent = "PARTIAL";
      badge.classList.remove("paid", "due");
      badge.classList.add("partial");
    } else {
      badge.textContent = "DUE";
      badge.classList.remove("paid", "partial");
      badge.classList.add("due");
    }
  }

  // Shared function to generate invoice image
  function generateInvoiceImage() {
    return new Promise((resolve, reject) => {
      // Add print-specific styles temporarily to make it look like the print version
      document.body.classList.add('preparing-image');
      
      // Create a style element for temporary print-like styling
      const tempStyle = document.createElement('style');
      tempStyle.textContent = `
        .preparing-image input[type="text"], 
        .preparing-image input[type="date"], 
        .preparing-image input[type="number"] {
          border: none !important;
          box-shadow: none !important;
          padding: 4px 0 !important;
          background: transparent !important;
        }
        
        .preparing-image .total-section {
          background-color: transparent !important;
          padding: 10px 0 !important;
        }
        
        .preparing-image th {
          background-color: #f8f9fa !important;
          color: #000 !important;
        }
        
        .preparing-image .status-badge {
          border: 1px solid currentColor !important;
          background-color: transparent !important;
        }
        
        .preparing-image .buttons-container {
          display: none !important;
        }
      `;
      document.head.appendChild(tempStyle);

      // Calculate what needs to be captured
      const container = document.querySelector(".container");
      const footer = document.querySelector(".footer");
      
      // Create a temporary wrapper div to hold both container and footer
      const wrapper = document.createElement('div');
      wrapper.style.background = '#fff';
      wrapper.style.maxWidth = '800px';
      wrapper.style.margin = '0 auto';
      wrapper.style.padding = '0';
      
      // Clone the elements to avoid modifying the originals
      const containerClone = container.cloneNode(true);
      const footerClone = footer.cloneNode(true);
      
      // Append clones to wrapper
      wrapper.appendChild(containerClone);
      wrapper.appendChild(footerClone);
      
      // Temporarily add wrapper to document
      document.body.appendChild(wrapper);
      
      // Use html2canvas to capture the wrapper
      html2canvas(wrapper, {
        scale: 1.5,
        useCORS: true,
        logging: false,
        allowTaint: true,
        backgroundColor: '#ffffff'
      }).then(canvas => {
        // Convert canvas to JPEG
        const jpegData = canvas.toDataURL('image/jpeg', 0.9);
        
        // Clean up
        document.body.removeChild(wrapper);
        document.head.removeChild(tempStyle);
        document.body.classList.remove('preparing-image');
        
        resolve({
          jpegData: jpegData,
          customerName: document.getElementById("customer-name").value.trim() || "unnamed",
          invoiceNumber: document.getElementById("invoice-number").textContent
        });
      }).catch(err => {
        // Clean up in case of error
        if (document.body.contains(wrapper)) document.body.removeChild(wrapper);
        if (document.head.contains(tempStyle)) document.head.removeChild(tempStyle);
        document.body.classList.remove('preparing-image');
        reject(err);
      });
    });
  }

  // New function that combines image saving and printing
  function saveImageAndPrint() {
    generateInvoiceImage().then(result => {
      // Create a temporary link and trigger download
      const link = document.createElement('a');
      link.download = `ISG invoice-${result.customerName}-${result.invoiceNumber}.jpg`;
      link.href = result.jpegData;
      link.click();
      
      // Trigger the print dialog after a slight delay
      setTimeout(() => {
        window.print();
      }, 500);
    }).catch(err => {
      console.error("Error generating invoice image:", err);
      alert("There was an error generating the invoice image. Please try again.");
    });
  }

  // Function to just save the image (no printing)
  function saveAsImage() {
    generateInvoiceImage().then(result => {
      // Create a temporary link and trigger download
      const link = document.createElement('a');
      link.download = `ISG invoice-${result.customerName}-${result.invoiceNumber}.jpg`;
      link.href = result.jpegData;
      link.click();
    }).catch(err => {
      console.error("Error saving invoice as image:", err);
      alert("There was an error saving the invoice as an image. Please try again.");
    });
  }

  // Add input event listeners to all initial inputs
  document.getElementById("invoice-body").addEventListener("input", updateTotal);
  
  // Initialize calculations
  updateTotal();
</script>

</body>
</html>
